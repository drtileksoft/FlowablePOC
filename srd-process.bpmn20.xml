<?xml version="1.0" encoding="UTF-8"?>
<definitions
    xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
    xmlns:flowable="http://flowable.org/bpmn"
    targetNamespace="http://flowable.org/bpmn">
    <process id="srdProcess" name="SRD External Task Process" isExecutable="true">
        <startEvent id="startEvent">
            <timerEventDefinition>
                <timeCycle>0 * * * * ?</timeCycle>
            </timerEventDefinition>
        </startEvent>

        <!-- Script Task: nastaví InitPayload na JSON řetězec -->
        <scriptTask id="initPayloadTask" name="Init payload" scriptFormat="groovy">
        <script><![CDATA[
            def json = '{"data":{"hello":"flow"}}'
            execution.setVariable('InitPayload', json)
        ]]></script>
        </scriptTask>

        <serviceTask id="externalTask" name="External SRD Task"
                     flowable:type="external-worker"
                     flowable:topic="srd.call"
                     flowable:async="true">
                <extensionElements>
                    <flowable:externalWorkerInParameter source="InitPayload" target="JsonPayload"></flowable:externalWorkerInParameter>
                    <!-- Worker musí na COMPLETE vrátit job-proměnnou JsonResponsePayload (ideálně type=json).
                        Tady ji mapujeme do procesní proměnné SrdCall1result -->
                    <flowable:externalWorkerOutParameter source="JsonResponsePayload" target="SrdCall1result"></flowable:externalWorkerOutParameter>
                </extensionElements>
        </serviceTask>
        <serviceTask id="externalTask2" name="External SRD Task 2"
                     flowable:type="external-worker"
                     flowable:topic="srd2.call"
                     flowable:async="true">
                <extensionElements>
                    <!-- pošli celý výsledek prvního volání jako vstup -->
                    <flowable:externalWorkerInParameter source="SrdCall1result" target="JsonPayload"></flowable:externalWorkerInParameter>
                    <!-- Výsledek druhého workeru mapuj do procesní SrdCall2result -->
                    <flowable:externalWorkerOutParameter source="JsonResponsePayload" target="SrdCall2result"></flowable:externalWorkerOutParameter>
                </extensionElements>
        </serviceTask>
        <endEvent id="endEvent" />
        <sequenceFlow sourceRef="startEvent" targetRef="initPayloadTask"/>
        <sequenceFlow sourceRef="initPayloadTask" targetRef="externalTask"/>
        <sequenceFlow sourceRef="externalTask" targetRef="externalTask2" />
        <sequenceFlow sourceRef="externalTask2" targetRef="endEvent" />
    </process>
</definitions>
